<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ä°laÃ§larÄ±nÄ± Unutma ğŸ˜ğŸ§¡</title>

  <!-- PWA & Theme -->
  <meta name="theme-color" content="#ffd1e6" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />

  <!-- iOS PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <style>
    :root {
      --pink:#ffd1e6; --dark:#2b1f2f; --accent:#ff6fa3; --accent2:#ff9fc2;
      --orange:#ff7f27;
    }
    html, body { height:100%; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--dark); }

    /* Daha sade arka plan + arada kalpler */
    body {
      background:
        linear-gradient(180deg,#ffe8f1 0%,#ffd3e4 100%);
      position:relative; overflow-x:hidden;
    }
    /* Kalp deseni: pembe & turuncu, geniÅŸ aralÄ±klÄ± ve yumuÅŸak */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.15;
      background-image:
        radial-gradient(circle 6px at 12% 18%, #ff6fa3 99%, transparent 100%),
        radial-gradient(circle 7px at 72% 28%, #ff7f27 99%, transparent 100%),
        radial-gradient(circle 5px at 28% 70%, #ff6fa3 99%, transparent 100%),
        radial-gradient(circle 6px at 88% 82%, #ff7f27 99%, transparent 100%);
      background-size: 420px 340px;
      background-repeat: no-repeat;
    }

    .app { max-width:900px; margin:0 auto; padding:24px; }
    .card { background:#fff; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:20px; margin:16px 0; }
    .title { display:flex; align-items:center; gap:10px; font-size:1.6rem; font-weight:800; flex-wrap:wrap; }
    .title .badge { background:#ffe6f1; color:#ff4f96; padding:6px 10px; border-radius:999px; font-weight:700; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > * { flex:1 1 220px; min-width:220px; }
    label { display:block; font-size:.9rem; margin-bottom:6px; }
    input, select { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e8d4df; background:#fff; }
    button { padding:12px 16px; border:none; border-radius:14px; background:var(--accent); color:#fff; font-weight:700; cursor:pointer; }
    button.secondary { background:#eee; color:#333; }
    button.danger { background:#ef476f; display:flex; align-items:center; gap:6px; }
    .trash { width:16px; height:16px; display:inline-block; }
    .muted{ color:#6a5a66; font-size:.95rem; }
    .list { display:grid; grid-template-columns:1fr; gap:12px; }
    .pill { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border:1px solid #f4d7e5; border-radius:14px; }
    .pill h4 { margin:0; font-size:1rem; }
    .lang { margin-left:auto; }
    .foot { text-align:center; color:#6a5a66; font-size:.85rem; margin-top:8px; }
    .orange-heart { color: var(--orange); }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="title">
        <span>Ä°laÃ§larÄ±nÄ± Unutma ğŸ˜<span class="orange-heart">ğŸ§¡</span> / <em>Take Your Medicine</em></span>
        <span class="badge">PWA</span>
        <select id="lang" class="lang" aria-label="Dil / Language">
          <option value="tr" selected>TÃ¼rkÃ§e</option>
          <option value="en">English</option>
        </select>
      </div>
      <p class="muted" id="strap">Kendine iyi bak. Ä°lacÄ±n zamanÄ± geldi.</p>
    </div>

    <div class="card" id="formCard">
      <h3 id="addTitle">Ä°laÃ§ Ekle</h3>
      <div class="row">
        <div>
          <label for="name">Ä°laÃ§ adÄ± / Medication</label>
          <input id="name" placeholder="Ã–rn: Metformin 500 mg"/>
        </div>
        <div>
          <label for="time">Saat</label>
          <input id="time" type="time"/>
        </div>
        <div>
          <label for="repeat">Tekrar</label>
          <select id="repeat">
            <option value="daily">Her gÃ¼n / Daily</option>
            <option value="every12">12 saatte bir / q12h</option>
            <option value="every8">8 saatte bir / q8h</option>
            <option value="weekly">HaftalÄ±k / Weekly</option>
          </select>
        </div>
        <div>
          <label for="tz">Zaman Dilimi / Time Zone</label>
          <select id="tz"></select>
        </div>
      </div>
      <div class="row">
        <div style="flex:1 1 100%">
          <label for="notes">GÃ¼nlÃ¼k sÃ¶z / Daily phrase (bildirimde de gÃ¶sterilir)</label>
          <input id="notes" placeholder="Seni seviyorum! Ä°yi ki varsÄ±n!"/>
        </div>
      </div>
      <div class="row">
        <button id="save">Kaydet</button>
        <button id="clear" class="secondary">Temizle</button>
      </div>
    </div>

    <div class="card">
      <h3 id="listTitle">HatÄ±rlatÄ±cÄ±lar</h3>
      <div id="empty" class="muted">HenÃ¼z hatÄ±rlatÄ±cÄ± yok.</div>
      <div class="list" id="list"></div>
    </div>

    <p class="foot">
      Bildirim ve ses iÃ§in izin veriniz. â€œAna Ekrana Ekleâ€ ile uygulama olarak kullanabilirsiniz.
      iOSâ€™ta arka planda gerÃ§ek push iÃ§in ek sunucu gerekir (aÅŸaÄŸÄ±daki notlara bakÄ±n).
    </p>
  </div>

  <audio id="ding" preload="auto" src="./sounds/chime.wav"></audio>

  <script>
    // i18n strings
    const STR = {
      tr: {
        strap:"Kendine iyi bak. Ä°lacÄ±n zamanÄ± geldi.", add:"Ä°laÃ§ Ekle", list:"HatÄ±rlatÄ±cÄ±lar",
        empty:"HenÃ¼z hatÄ±rlatÄ±cÄ± yok.", taken:"AldÄ±m âœ… ğŸ®ğŸ™‚", snooze:"Ertele â° ğŸ®ğŸ™",
        edit:"DÃ¼zenle", del:"Sil", save:"Kaydet", clear:"Temizle"
      },
      en: {
        strap:"Take care. Itâ€™s time for your medicine.", add:"Add Medication", list:"Reminders",
        empty:"No reminders yet.", taken:"Taken âœ… ğŸ®ğŸ™‚", snooze:"Snooze â° ğŸ®ğŸ™",
        edit:"Edit", del:"Delete", save:"Save", clear:"Clear"
      }
    };

    // Ã–rnek sevimli sÃ¶zler (fallback)
    const phrasesTR = ["Seni seviyorum!", "Ä°yi ki varsÄ±n!", "Ben yaparÄ±m, ÅŸov olur!", "Erteleme, ÅŸimdi al!"];
    const phrasesEN = ["I love you!", "So glad you exist!", "Showtime!", "Donâ€™t delayâ€”take it now!"];

    const $ = sel => document.querySelector(sel);
    const listEl = $('#list'), emptyEl = $('#empty'), langSel = $('#lang');

    function t(key){ return STR[langSel.value][key]; }
    function nowMinutes(tz){ const d=new Date(); return Number(new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tz}).format(d).replace(':','')); }

    // Timezone dropdown
    const tzSel = $('#tz');
    (function fillTZ(){
      try {
        const zones = Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : ["UTC"];
        zones.forEach(z=>{
          const opt = document.createElement('option');
          opt.value=z; opt.textContent=z; tzSel.appendChild(opt);
        });
        tzSel.value = localStorage.getItem('tz') || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
      } catch(e){ tzSel.innerHTML='<option value="UTC">UTC</option>'; tzSel.value='UTC'; }
      tzSel.onchange = ()=> localStorage.setItem('tz', tzSel.value);
    })();

    function saveStore(items){ localStorage.setItem('meds', JSON.stringify(items)); }
    function loadStore(){ try{return JSON.parse(localStorage.getItem('meds')||'[]')}catch(e){return []} }

    function render(){
      const items = loadStore();
      listEl.innerHTML='';
      emptyEl.style.display = items.length? 'none':'block';
      items.forEach((it,idx)=>{
        const card = document.createElement('div'); card.className='pill';
        const left = document.createElement('div');
        left.innerHTML = `<h4>${it.name}</h4>
          <div class="muted">${it.time} â€¢ ${it.repeat} â€¢ ${it.tz} ${it.notes? 'â€¢ '+it.notes:''}</div>`;
        const actions = document.createElement('div'); actions.className='actions';
        const ok = document.createElement('button'); ok.textContent=t('taken'); ok.className='ok';
        const sn = document.createElement('button'); sn.textContent=t('snooze'); sn.className='snooze';
        const ed = document.createElement('button'); ed.textContent=t('edit');
        const dl = document.createElement('button'); dl.className='danger'; dl.innerHTML = `
          <svg class="trash" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M9 3h6l1 2h5v2H3V5h5l1-2Zm1 8v6h2v-6h-2Zm4 0v6h2v-6h-2ZM5 7h14l-1 14H6L5 7Z"/>
          </svg> ${t('del')}`;
        actions.append(ok,sn,ed,dl); card.append(left,actions); listEl.append(card);
        ok.onclick=()=>markTaken(idx);
        sn.onclick=()=>snooze(idx,10);
        ed.onclick=()=>editItem(idx);
        dl.onclick=()=>delItem(idx);
      });
      // statik metinler
      $('#strap').textContent = t('strap');
      $('#addTitle').textContent = t('add');
      $('#listTitle').textContent = t('list');
      $('#save').textContent = t('save');
      $('#clear').textContent = t('clear');
      emptyEl.textContent = t('empty');
    }

    function addItem(){
      const name=$('#name').value.trim();
      const time=$('#time').value; // "HH:MM"
      if(!name||!time) return alert('Ä°sim ve saat gerekli / Name and time required');
      const notes=$('#notes').value.trim();
      const repeat=$('#repeat').value;
      const tz = tzSel.value || 'UTC';
      const items=loadStore();
      items.push({name,time,repeat,notes,tz,nextDue:time, snoozeUntil:null});
      saveStore(items); render();
      $('#name').value=''; $('#time').value=''; $('#notes').value='';
    }

    function editItem(i){
      const items=loadStore(); const it=items[i];
      $('#name').value=it.name; $('#time').value=it.time; $('#notes').value=it.notes||''; $('#repeat').value=it.repeat; tzSel.value=it.tz;
      items.splice(i,1); saveStore(items); render();
    }

    function delItem(i){ const items=loadStore(); items.splice(i,1); saveStore(items); render(); }

    function markTaken(i){
      const items=loadStore(); const it=items[i];
      it.snoozeUntil=null; it.nextDue = nextDueFrom(it);
      saveStore(items); render();
    }

    function snooze(i, minutes){
      const items=loadStore(); const it=items[i];
      const now = new Date();
      const sno = new Date(now.getTime()+minutes*60000);
      const hh = sno.toLocaleString('en-GB',{hour:'2-digit',hour12:false,timeZone:it.tz});
      const mm = sno.toLocaleString('en-GB',{minute:'2-digit',timeZone:it.tz});
      it.snoozeUntil = `${hh}:${mm}`;
      saveStore(items); render();
    }

    function nextDueFrom(it){
      const [hh,mm]=it.time.split(':').map(Number);
      const base = new Date();
      // hedef TZ'ye gÃ¶re gÃ¼nÃ¼/saatleri kurgulamak basitleÅŸtirilmiÅŸ yaklaÅŸÄ±m
      base.setHours(hh,mm,0,0);
      if(it.repeat==='every8') base.setHours(base.getHours()+8);
      else if(it.repeat==='every12') base.setHours(base.getHours()+12);
      else if(it.repeat==='weekly') base.setDate(base.getDate()+7);
      else base.setDate(base.getDate()+1); // daily
      return base.toTimeString().slice(0,5);
    }

    async function ensurePerms(){
      try { if(window.Notification && Notification.permission!=='granted') await Notification.requestPermission(); } catch(e){}
    }

    function notify(it){
      // GÃ¼nlÃ¼k sÃ¶z: kullanÄ±cÄ± girdiyse onu, yoksa varsayÄ±lanlardan
      const msgs = (langSel.value==='tr' ? phrasesTR : phrasesEN);
      const phrase = (it.notes && it.notes.trim()) ? it.notes.trim() : msgs[Math.floor(Math.random()*msgs.length)];
      const body = `${it.name} â€¢ ${it.time} ${it.tz}\n${phrase}`;
      try{
        new Notification('Ä°laÃ§larÄ±nÄ± Unutma ğŸ˜ğŸ§¡', { body, icon:'./icons/icon-192.png', tag: it.name });
      }catch(e){ alert(body); }
      const ding=$('#ding'); if(ding){ ding.currentTime=0; ding.play().catch(()=>{}); }
    }

    function tick(){
      const items=loadStore(); if(!items.length) return;
      const tz = tzSel.value || 'UTC';
      // â€œHHMMâ€ integer kÄ±yaslamasÄ±
      const d = new Date();
      const hh = new Intl.DateTimeFormat('en-GB',{hour:'2-digit',hour12:false,timeZone:tz}).format(d);
      const mm = new Intl.DateTimeFormat('en-GB',{minute:'2-digit',timeZone:tz}).format(d);
      const mins = Number(hh+mm);

      items.forEach((it,i)=>{
        const due = it.snoozeUntil || it.nextDue || it.time;
        const parts = due.split(':'); if(parts.length<2) return;
        const dueN = Number(parts[0].padStart(2,'0')+parts[1].padStart(2,'0'));
        if(dueN === mins){
          notify(it);
          it.snoozeUntil=null;
          it.nextDue = nextDueFrom(it);
        }
      });
      saveStore(items);
    }

    // UI wiring
    $('#save').onclick=addItem;
    $('#clear').onclick=()=>{ $('#name').value=''; $('#time').value=''; $('#notes').value=''; };
    langSel.onchange=render;

    // boot
    ensurePerms();
    render();
    setInterval(tick, 60*1000);

    // PWA service worker
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js'); });
    }
  </script>
</body>
</html>

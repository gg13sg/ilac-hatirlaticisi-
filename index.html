<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ä°laÃ§larÄ±nÄ± Unutma ğŸ˜ğŸ§¡</title>

  <!-- PWA / GitHub Pages -->
  <meta name="theme-color" content="#ffe9f1" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --cream:#fff7fb;           /* daha sade krem pembe zemin */
      --cream2:#ffe3f0;
      --dark:#2b1f2f;
      --accent:#ff6fa3;
      --accent2:#ff9fc2;
      --ok:#34c759;
      --snooze:#ff9500;
      --danger:#ef476f;
      --heartPink:#ff6fa3;
      --heartOrange:#ff7f27;
      --card:#ffffff;
      --border:#f0d9e4;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--dark)}

    /* Sade degrade + aralara kalpler */
    body{
      background:
        radial-gradient(24px 16px at 12% 18%, rgba(255,127,39,.12) 35%, transparent 36%),
        radial-gradient(22px 14px at 78% 12%, rgba(255,111,163,.12) 35%, transparent 36%),
        radial-gradient(20px 12px at 85% 82%, rgba(255,127,39,.10) 35%, transparent 36%),
        radial-gradient(18px 12px at 15% 85%, rgba(255,111,163,.10) 35%, transparent 36%),
        linear-gradient(180deg, var(--cream) 0%, var(--cream2) 100%);
      background-attachment: fixed;
    }

    .app{max-width:920px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px;margin:16px 0}
    .title{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .title h1{margin:0;font-size:1.55rem}
    .badge{background:#ffe6f1;color:#ff4f96;padding:6px 10px;border-radius:999px;font-weight:700}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    label{display:block;font-size:.9rem;margin-bottom:6px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e8d4df;background:#fff}
    button{padding:12px 16px;border:none;border-radius:14px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#eee;color:#333}
    button.ok{background:var(--ok)}
    button.snooze{background:var(--snooze)}
    button.danger{background:var(--danger)}
    .list{display:grid;grid-template-columns:1fr;gap:12px}
    .pill{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--border);border-radius:14px;background:#fff}
    .pill h4{margin:0;font-size:1rem}
    .muted{color:#6a5a66;font-size:.92rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .lang{margin-left:auto}
    .foot{text-align:center;color:#6a5a66;font-size:.85rem;margin-top:8px}
    .tiny{font-size:.85rem}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="title">
        <h1>Ä°laÃ§larÄ±nÄ± Unutma ğŸ˜ğŸ§¡ <span class="tiny">/ <em>Take Your Medicine</em></span></h1>
        <span class="badge">PWA</span>
        <select id="lang" class="lang" aria-label="Dil / Language">
          <option value="tr" selected>TÃ¼rkÃ§e</option>
          <option value="en">English</option>
        </select>
      </div>
      <p class="muted" id="quote">Kendine iyi bak. Ä°lacÄ±n zamanÄ± geldi.</p>

      <div class="row">
        <div>
          <label for="tz">Saat Dilimi / Time Zone</label>
          <select id="tz"></select>
        </div>
      </div>
    </div>

    <div class="card" id="formCard">
      <h3 id="addTitle">Ä°laÃ§ Ekle</h3>
      <div class="row">
        <div>
          <label for="name">Ä°laÃ§ adÄ± / Medication</label>
          <input id="name" placeholder="Ã–rn: Metformin 500 mg">
        </div>
        <div>
          <label for="time">Saat (24s)</label>
          <input id="time" type="time">
        </div>
        <div>
          <label for="repeat">Tekrar</label>
          <select id="repeat">
            <option value="daily">Her gÃ¼n / Daily</option>
            <option value="every12">12 saatte bir / q12h</option>
            <option value="every8">8 saatte bir / q8h</option>
            <option value="weekly">HaftalÄ±k / Weekly</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="notes">Not (Ä°steÄŸe baÄŸlÄ±) / Notes (optional)</label>
          <input id="notes" placeholder="AÃ§ tok... / with meal...">
        </div>
      </div>
      <div class="row">
        <button id="save">Kaydet</button>
        <button id="clear" class="secondary">Temizle</button>
      </div>
    </div>

    <div class="card">
      <h3 id="listTitle">HatÄ±rlatÄ±cÄ±lar</h3>
      <div id="empty" class="muted">HenÃ¼z hatÄ±rlatÄ±cÄ± yok.</div>
      <div class="list" id="list"></div>
    </div>

    <p class="foot">
      Bildirim ve ses iÃ§in izin veriniz. Bu uygulama Ã§evrimdÄ±ÅŸÄ± da Ã§alÄ±ÅŸÄ±r ve Ana Ekrana eklenebilir.
    </p>
  </div>

  <audio id="ding" preload="auto" src="./sounds/chime.mp3"></audio>

  <script>
    /* ====== Dil / i18n ====== */
    const STR = {
      tr:{ add:"Ä°laÃ§ Ekle", list:"HatÄ±rlatÄ±cÄ±lar", empty:"HenÃ¼z hatÄ±rlatÄ±cÄ± yok.",
           taken:"AldÄ±m âœ… ğŸ®ğŸ™‚", snooze:"Ertele â° ğŸ®ğŸ™", edit:"DÃ¼zenle", del:"Sil ğŸ§¹",
           req:"Ä°sim ve saat gerekli / Name and time required" },
      en:{ add:"Add Medication", list:"Reminders", empty:"No reminders yet.",
           taken:"Taken âœ… ğŸ®ğŸ™‚", snooze:"Snooze â° ğŸ®ğŸ™", edit:"Edit", del:"Delete ğŸ§¹",
           req:"Name and time required" }
    };
    const QUOTES_TR = [
      "Kendine iyi bak. Ä°lacÄ±n zamanÄ± geldi.",
      "Seni seviyorum! Ä°yi ki varsÄ±n!",
      "Ä°lacÄ± iÃ§erim, erteleme yavrum!",
      "Ã‡ekilme, yaÅŸarsÄ±n; uyarÄ±yorum, al onu!",
      "Ben yaparÄ±m, ÅŸov olur!"
    ];
    const QUOTES_EN = [
      "Take care. Itâ€™s medicine time.",
      "I love you â€” so glad you exist!",
      "Donâ€™t delay â€” take it now!",
      "Donâ€™t back off â€” take it!",
      "Iâ€™ve got this â€” showtime!"
    ];
    const $ = s => document.querySelector(s);
    const listEl = $('#list'), emptyEl = $('#empty'), langSel = $('#lang'), tzSel = $('#tz');

    /* ====== Saat dilimi listesi (yaygÄ±n TZ + mevcut) ====== */
    const COMMON_TZ = ["Europe/Istanbul","UTC","Europe/London","Europe/Paris","America/New_York","America/Los_Angeles","Asia/Dubai","Asia/Tokyo","Australia/Sydney"];
    const currentTZ = Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC";
    const tzSet = Array.from(new Set([currentTZ, ...COMMON_TZ])).sort();
    tzSet.forEach(z => {
      const o = document.createElement('option');
      o.value = z; o.textContent = z; if(z===currentTZ) o.selected = true; tzSel.appendChild(o);
    });

    /* ====== Depo ====== */
    const K = { meds:'meds', tz:'tz', lang:'lang' };
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function load(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) ?? fallback }catch{ return fallback } }

    /* ====== YardÄ±mcÄ±lar ====== */
    function t(key){ return STR[langSel.value][key]; }
    function quoteToday(){
      const d = new Date();
      const idx = d.getFullYear()*10000 + (d.getMonth()+1)*100 + d.getDate();
      const arr = langSel.value==='tr'? QUOTES_TR : QUOTES_EN;
      return arr[idx % arr.length];
    }
    function minsInTZ(date, tz){
      // date -> seÃ§ili tz'de saat:dakika
      const fmt = new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tz});
      const [hh,mm] = fmt.format(date).split(':').map(Number);
      return hh*60 + mm;
    }

    function render(){
      $('#addTitle').textContent = t('add');
      $('#listTitle').textContent = t('list');
      emptyEl.textContent = t('empty');
      $('#quote').textContent = quoteToday();

      const items = load(K.meds, []);
      listEl.innerHTML = '';
      emptyEl.style.display = items.length ? 'none' : 'block';

      items.forEach((it, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'pill';

        const left = document.createElement('div');
        left.innerHTML = `<h4>${it.name}</h4><div class="muted">${it.time} â€¢ ${it.repeat} ${it.notes? 'â€¢ '+it.notes:''}</div>`;

        const acts = document.createElement('div');
        acts.className = 'actions';

        const ok = document.createElement('button'); ok.className='ok'; ok.textContent=t('taken');
        const sn = document.createElement('button'); sn.className='snooze'; sn.textContent=t('snooze');
        const ed = document.createElement('button'); ed.textContent=t('edit');
        const dl = document.createElement('button'); dl.className='danger'; dl.textContent=t('del');

        ok.onclick = () => markTaken(i);
        sn.onclick = () => snooze(i, 10);
        ed.onclick = () => editItem(i);
        dl.onclick = () => delItem(i);

        acts.append(ok,sn,ed,dl);
        wrap.append(left,acts);
        listEl.append(wrap);
      });
    }

    function addItem(){
      const name=$('#name').value.trim();
      const time=$('#time').value;
      if(!name || !time){ alert(t('req')); return; }
      const notes=$('#notes').value.trim();
      const repeat=$('#repeat').value;

      const items = load(K.meds, []);
      items.push({name,time,repeat,notes,nextDue:time,snoozeUntil:null});
      save(K.meds, items);
      $('#name').value=''; $('#time').value=''; $('#notes').value='';
      render();
    }
    function editItem(i){
      const items = load(K.meds, []);
      const it = items[i];
      $('#name').value=it.name; $('#time').value=it.time; $('#notes').value=it.notes||''; $('#repeat').value=it.repeat;
      items.splice(i,1); save(K.meds, items); render();
    }
    function delItem(i){
      const items = load(K.meds, []);
      items.splice(i,1); save(K.meds, items); render();
    }
    function markTaken(i){
      const items=load(K.meds, []);
      const it=items[i];
      it.snoozeUntil = null;
      it.nextDue = nextDueFrom(it);
      save(K.meds, items); render();
    }
    function snooze(i, minutes){
      const items=load(K.meds, []);
      const it=items[i];
      const d = new Date(); d.setMinutes(d.getMinutes()+minutes);
      const fmt = new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tzSel.value});
      it.snoozeUntil = fmt.format(d);
      save(K.meds, items); render();
    }
    function nextDueFrom(it){
      const [hh,mm] = it.time.split(':').map(Number);
      const d = new Date();
      // tz'ye gÃ¶re yeni due saati
      const inTZ = new Date(new Date().toLocaleString('en-US', { timeZone: tzSel.value }));
      inTZ.setHours(hh,mm,0,0);
      if(it.repeat==='every8') inTZ.setHours(inTZ.getHours()+8);
      else if(it.repeat==='every12') inTZ.setHours(inTZ.getHours()+12);
      else if(it.repeat==='weekly') inTZ.setDate(inTZ.getDate()+7);
      else inTZ.setDate(inTZ.getDate()+1);
      const fmt = new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tzSel.value});
      return fmt.format(inTZ);
    }

    async function ensurePerms(){
      try{ if(Notification && Notification.permission!=='granted'){ await Notification.requestPermission(); } }catch{}
    }
    function notify(it){
      const phrase = quoteToday();
      const body = `${it.name} â€¢ ${it.time}\n${phrase}`;
      try{
        new Notification('Ä°laÃ§larÄ±nÄ± Unutma ğŸ˜ğŸ§¡', { body, icon:'./icons/icon-192.png', tag: it.name });
      }catch{ alert(`${it.name}\n${phrase}`); }
      const ding = $('#ding'); ding.currentTime=0; ding.play().catch(()=>{});
    }

    function tick(){
      const items = load(K.meds, []); if(!items.length) return;
      const minsNow = minsInTZ(new Date(), tzSel.value);
      items.forEach(it=>{
        const due = it.snoozeUntil || it.nextDue || it.time;
        const [hh,mm] = due.split(':').map(Number);
        const dueM = hh*60+mm;
        if(dueM === minsNow){
          notify(it);
          it.snoozeUntil = null;
          it.nextDue = nextDueFrom(it);
        }
      });
      save(K.meds, items);
    }

    /* ====== Events & Boot ====== */
    $('#save').onclick = addItem;
    $('#clear').onclick = ()=>{ $('#name').value=''; $('#time').value=''; $('#notes').value=''; };
    langSel.onchange = ()=>{ save(K.lang, langSel.value); render(); };
    tzSel.onchange = ()=>{ save(K.tz, tzSel.value); render(); };

    // restore prefs
    const savedLang = load(K.lang, null); if(savedLang){ langSel.value = savedLang; }
    const savedTZ = load(K.tz, null); if(savedTZ){ tzSel.value = savedTZ; }

    ensurePerms();
    render();
    setInterval(tick, 60*1000);

    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
    }
  </script>
</body>
</html>
